# Requirements: 业务闭环与数据可见性

> **目标**：明确各数据源（用量、支出、Git 贡献、Hook）的展示条件，补齐闭环可验证性与无 Hook 时的产品形态，使「谁能看到什么、为什么看不到」可预期、可排查、可引导。  
> **优先级**：P0（体验与可运维性）  
> **预估工作量**：3–5 天

---

## 文档联动

- requirements: `.kiro/specs/cursor-admin-loop-and-data/requirements.md`
- design: `.kiro/specs/cursor-admin-loop-and-data/design.md`
- tasks: `.kiro/specs/cursor-admin-loop-and-data/tasks.md`

---

## 1. 背景与动机

### 1.1 当前问题

1. **Git 贡献不展示**  
   项目详情、我的项目、我的贡献中的「Git 贡献」经常为空。原因未在产品中显式说明，用户不知道是「未配置」还是「采集失败」。

2. **支出管理不展示**  
   支出管理页无数据或一直加载。原因未区分：未配置 Cursor API、同步未跑、或 API 未返回支出（如非计费套餐）。

3. **闭环不可验证**  
   业务闭环依赖 Hook 上报；若检测不到 Hook 上报，项目参与、成本归属、贡献得分/排行均无数据。平台当前无「Hook 是否已接通」「闭环是否通」的显式入口，只能通过各页空状态间接推断。

4. **无 Hook 时体验差**  
   闭环未通时，各页空状态分散，缺少统一引导：先展示什么、如何引导「装 Hook → 看到数据」、是否弱化/隐藏依赖 Hook 的入口。

### 1.2 设计目标

- **数据可展示条件透明**：用量、支出、Git 贡献、Hook 四类数据的「为何不展示」与「如何能展示」在文档与产品中可查、可执行排查。
- **闭环可验证**：提供「闭环健康 / Hook 状态」的判定与展示，使管理员/成员能确认「是否已有 Hook 上报」。
- **无 Hook 时产品形态明确**：定义闭环未通时的优先展示顺序、引导动线及可选策略（弱化/隐藏部分入口）。

---

## 2. 数据可见性需求

### 2.1 用量总览（Cursor API）

- **数据流**：定时同步 `get_daily_usage` → `daily_usage` 表 → 管理端「用量总览」。
- **可展示条件**：
  - [ ] 已配置 `CURSOR_API_TOKEN`（Team/Enterprise Admin API Key）。
  - [ ] 同步任务已至少成功执行一次（默认每小时）。
- **不展示时**：前端/文档说明「请配置 Cursor API 并等待同步完成」；可选展示「最近同步时间」或同步失败原因。

### 2.2 支出管理（Cursor API）

- **数据流**：定时同步 `get_spend` → `spend_snapshots` 表 → 管理端「支出管理」。
- **可展示条件**：
  - [ ] 已配置 `CURSOR_API_TOKEN`。
  - [ ] 同步任务已至少成功执行一次。
  - [ ] Cursor 团队套餐支持「支出」接口（`/teams/spend` 返回 `teamMemberSpend`）；部分套餐可能无该数据。
- **不展示时**：区分「同步未跑/失败」与「API 无支出数据」；前端或帮助文案说明「支出数据来自 Cursor 计费周期，请确认 API 权限与套餐」。

### 2.3 Git 贡献（Git 采集）

- **数据流**：定时任务对「已立项且填写了关联仓库」的项目执行 clone/fetch → 解析 commit → `git_contributions` 表 → 项目详情 / 我的项目 / 我的贡献。
- **可展示条件**：
  - [ ] 项目已填写「关联仓库」（`git_repos` 非空），且采集服务已配置 `GIT_REPOS_ROOT`（可写目录）。
  - [ ] Collector 容器/环境中已安装 `git`，且定时任务（在 sync 之后）已至少执行一次。
  - [ ] 仓库可被采集服务访问（公开仓库或配置了凭证的私有仓库）。
- **不展示时**：前端/文档说明「请为项目配置关联仓库并确保采集服务已执行 Git 采集」；设计文档提供排查清单（见 design.md）。

### 2.4 Hook 上报（项目参与、成本归属、贡献得分/排行）

- **数据流**：成员在匹配工作目录下使用 Cursor，Hook `stop` 事件 POST /api/sessions → `agent_sessions`（含 `project_id`）→ 项目参与、项目详情成本/参与成员、贡献度会话维度、排行榜。
- **可展示条件**：
  - [ ] 项目已在「项目管理」立项且工作目录规则与成员实际路径一致。
  - [ ] 成员在对应目录下使用 Cursor，且已安装并启用 Hook（`.cursor/hook/` 或项目级 Hook）。
  - [ ] Hook 能访问 Collector 的 `/api/projects/whitelist` 与 `/api/sessions`；beforeSubmitPrompt 匹配成功并写入 project_id，stop 时上报。
- **不展示时**：见「闭环可验证性」与「无 Hook 时产品形态」。

---

## 3. 闭环可验证性需求

### 3.1 定义「闭环已接通」

- **判定**：在约定时间范围内（如最近 7 天）存在至少一条 `agent_sessions` 记录（可选：且 `project_id IS NOT NULL`）。
- **粒度**：可区分「全局是否有过 Hook 上报」与「某成员/某项目是否有过 Hook 上报」。

### 3.2 管理端可见

- [ ] 提供「闭环健康」或「Hook 状态」入口（如仪表盘卡片、设置页、或项目参与页顶部）。
- [ ] 展示至少一项：最近 N 天是否有 Hook 上报、已接入 Hook 的成员数、最近一次上报时间。
- [ ] 当从未有过 Hook 上报时，展示明确提示与引导（安装步骤、文档链接）。

### 3.3 成员端可选

- [ ] 「我的贡献」等页在未接入时已有 hook_adopted 提示；可补充「如何接入」链接或短引导。

---

## 4. 无 Hook 时的产品形态需求

### 4.1 优先展示顺序

- [ ] **闭环未通时**（平台从未收到 Hook 上报）：优先展示「用量总览」「支出管理」（若已有数据）、「项目管理」；突出「安装 Hook 以解锁项目参与与激励」的引导。
- [ ] **闭环已通时**：按现有导航展示；可选在仪表盘弱化「引导安装」强调。

### 4.2 引导与入口

- [ ] 至少一处固定入口：如首页/仪表盘卡片或项目参与页顶部，文案为「接通 Hook 后可查看项目参与、贡献得分与排行」，并链接到《Hook 安装与验证》文档或 Hook 状态页。
- [ ] 依赖 Hook 的页面（项目参与、排行榜、我的贡献）在空状态时统一指向该引导，避免重复长文案。

### 4.3 可选策略（设计文档中定稿）

- [ ] 是否在「从未有 Hook 上报」时隐藏或折叠「项目参与」「排行榜」入口，由 design 与产品决策；若隐藏，需保留可从设置/帮助进入的路径。

---

## 5. 非功能需求

- **可排查**：design 提供「Git 不展示」「支出不展示」的排查清单（配置项、日志、API 返回值）。
- **文档**：将「数据可见性条件」与「闭环可验证」「无 Hook 时形态」写入 `docs/` 或帮助中心，便于运维与用户自助。

---

## 6. 验收标准（Definition of Done）

- [ ] 文档：存在《数据可见性条件与排查》文档，覆盖用量、支出、Git、Hook 四类。
- [ ] API：存在「闭环健康 / Hook 状态」查询接口（如 GET /api/health/loop 或 /api/hook-status），返回最近 N 天是否有上报、可选成员数/最近时间。
- [ ] 前端：管理端至少一处展示 Hook 状态或闭环健康；无 Hook 时展示统一引导入口。
- [ ] 前端：支出管理、Git 贡献空状态或加载失败时，展示与「可展示条件」一致的短说明或帮助链接。
- [ ] 任务清单：tasks.md 中所有任务已完成或已标注暂缓及原因。

---

**维护者**：团队  
**最后更新**：2026-02-26
