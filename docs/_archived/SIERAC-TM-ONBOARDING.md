# 将本仓库（Sierac-tm）纳入平台

本文说明如何把当前工作目录（Sierac-tm）作为「已立项项目」维护在 Cursor Admin 平台，并在平台上看到各功能模块带来的数据。

## 一、在平台上创建/维护项目

### 若项目中尚未有「sierac-tm」

1. 打开管理端 → **项目管理** → 点击 **新建项目**。
2. 选择 **关联已有仓库**（不自动创建新仓库）。
3. 填写：
   - **项目名称**：`Sierac-tm`（或任意名称）
   - **工作目录规则**：你本机打开该项目的根路径，例如：
     - Windows：`D:\AI\Sierac-tm` 或 `d:/AI/Sierac-tm`
     - macOS/Linux：`/Users/xxx/Sierac-tm` 等
   - **已有仓库地址**（必填）：一行一个，例如  
     `https://github.com/sieran-chen/sierac-tm.git`  
     或 `git@github.com:sieran-chen/sierac-tm.git`（采集服务需能访问）
   - **创建人邮箱**：你的邮箱（用于记录立项人）
4. 保存后，项目会出现在项目列表中；点击项目名称可进入 **项目详情**。

### 若项目中已有「sierac-tm」但缺仓库或规则

1. 在 **项目管理** 列表找到该项目，点击 **编辑**。
2. 补全 **工作目录规则**（与你本机实际路径一致）和 **已有仓库地址**（Git 采集用）。
3. 保存。

工作目录规则用于：Hook 在 `beforeSubmitPrompt` 时根据当前 Cursor 的 workspace 根路径匹配白名单，匹配到的会话上报时会带上 `project_id`，从而在「成本」「参与成员」中展示。

## 二、在项目详情中看到「各部分数据」

项目详情页的每一块数据都标明了 **数据来源**，便于理解来自哪一模块。

| 区块         | 数据来源     | 说明 |
|--------------|--------------|------|
| **成本（本周期）** | Hook 上报    | 成员在符合工作目录规则的目录下使用 Cursor，且已安装并启用 Hook，会话结束时会上报到采集服务并归属到该项目。未装 Hook 或路径不匹配则不会计入。 |
| **参与成员**     | Hook 上报    | 同上，按成员聚合的会话次数与总时长。 |
| **Git 贡献**    | Git 采集     | 采集服务按配置的 `GIT_REPOS_ROOT` 与同步周期，对项目所填「关联仓库」执行 clone/fetch，解析 commit 与 diff，写入 `git_contributions`。 |

- **用量（Cursor API）**：按成员的请求数、Token、支出等在 **用量总览** 页查看，不在项目详情内按项目拆分；项目详情中的「成本」仅指 Hook 上报的会话次数与时长。

要让 **Git 贡献** 有数据，需同时满足：

- 项目在管理端**必须填写「关联仓库」**（已有仓库地址，一行一个 URL，如 `https://github.com/sieran-chen/sierac-tm.git`）。若立项时没填或填错，请到 **项目管理 → 编辑该项目**，在「已有仓库地址」里补全并保存。
- 采集服务已配置 **GIT_REPOS_ROOT**（Docker 默认 `/data/git-repos`，已挂载持久化卷），容器内已安装 **git**。
- Git 采集在**每次同步任务**里自动执行（与 Cursor API 同步同周期，默认约每小时）。只有 `git_repos` 非空的项目才会被采集；保存后等下一轮同步或重启 Collector 即可。

## 三、已立项但成本/参与成员仍为 0 时

项目已存在（如 http://8.130.50.168:3000/projects/1）却一直无数据，通常是以下两者之一：

1. **工作目录规则与本机路径不一致**  
   在项目详情页「基本信息」查看「工作目录规则」。你本机打开该仓库的**根路径**必须与其中一条**前缀匹配**（不区分大小写）。例如本机是 `D:\AI\Sierac-tm`，规则需包含 `D:/AI/Sierac-tm` 或 `d:/ai/sierac-tm`。若不对，在项目管理中**编辑**该项目，修改工作目录规则后保存。

2. **Hook 未被 Cursor 执行**  
   本仓库使用 `.cursor/hooks.json` + `.cursor/hook/cursor_hook.py`（已改为 `python` 命令）。在本仓库用 **Composer/Agent 跑完一次对话并关闭**，才算一次「完整 Agent 会话」，Hook 会在关闭时上报；再刷新项目详情。

更多排查见 `.cursor/hook/README.md`。

## 四、Git 贡献一直为空

Git 采集只处理**在管理端填了「关联仓库」（已有仓库地址）**的项目。若项目详情页「Git 贡献」始终没数据：

1. 打开 **项目管理** → 找到该项目（如 Sierac-tm）→ **编辑**。
2. 在「已有仓库地址」中填写本仓库地址（一行一个），例如：  
   `https://github.com/sieran-chen/sierac-tm.git`  
   保存。
3. 采集服务在**每次同步周期**（约每小时）会扫描所有已填 `git_repos` 的项目并 clone/fetch 仓库、解析 commit 写入 `git_contributions`。保存后等下一轮同步即可；也可**立即触发一次采集**（需 API Key）：  
   `curl -X POST -H "x-api-key: 你的INTERNAL_API_KEY" http://8.130.50.168:8000/api/admin/trigger-git-collect`

## 五、快速自检

- **项目管理** 中能看到「Sierac-tm」且点进详情能打开。
- **基本信息** 中能看到「关联仓库」或「仓库」、**工作目录规则**。
- **成本 / 参与成员**：若本机在该目录下用 Cursor 且装了 Hook，应能看到自己的会话与时长；否则会显示「暂无参与数据」并有说明文案。
- **Git 贡献**：若采集已跑过且仓库可访问，会看到按作者、日期的提交与 diff；否则会显示「暂无贡献数据」及配置提示。

## 六、本地 / 部署后验证

- **项目详情页**：打开任意项目 → 详情页应看到「成本」「参与成员」「Git 贡献」三块，每块带「来自 Hook 上报」或「来自 Git 采集」标签；基本信息中有关联仓库或工作目录规则。
- **E2E**：在 `cursor-admin/e2e` 下执行  
  `E2E_BASE_URL=http://你的管理端地址 npm run e2e -- spec-e2e-verification`  
  可验证立项弹窗、关联已有仓库、项目参与入口及项目详情数据来源标签。

---

**维护者**：见项目主文档  
**最后更新**：2026-02-26
