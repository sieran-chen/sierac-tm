---
description: 架构规范 — 适用于包结构、集成边界、collector、数据库。
globs:
  - cursor-admin/**/*.py
  - cursor-admin/**/*.ts
  - cursor-admin/**/*.tsx
  - docs/**/*.md
  - .kiro/specs/**/*.md
alwaysApply: false
---
# Sierac-tm 架构规范

> **版本**: v3.0.0 (2026-02-28)
> **架构真源**: `docs/ARCHITECTURE.md`

---

## 一、核心实体

**项目（Project）是平台的一等实体**。所有贡献数据、预算、激励都围绕「项目」组织。

- 管理员在平台「立项」→ 登记项目信息、关联仓库、设定预算与激励池。
- 系统通过 AI Code Tracking API 的 `repoName` 匹配 `projects.git_repos`，自动归属贡献数据。
- 纯服务端，不在成员机器上安装任何东西。

---

## 二、包结构

```
cursor-admin/
├── collector/           # 采集服务（Python, FastAPI）
│   ├── main.py          # 入口、API、定时任务
│   ├── sync.py          # Cursor Admin/Analytics API 同步
│   ├── ai_code_sync.py  # AI Code Tracking API 同步（核心）
│   ├── contribution_engine.py  # 贡献度计算与激励分配
│   ├── alerts.py        # 告警检测与通知
│   ├── cursor_api.py    # Cursor API 客户端（唯一出口）
│   ├── database.py      # 连接与迁移
│   └── config.py
├── db/migrations/       # SQL 迁移（幂等）
└── web/                 # 管理端 + 成员端（TypeScript, React）
    └── src/
        └── pages/
            ├── ProjectsPage.tsx        # 项目管理
            ├── ProjectDetailPage.tsx   # 项目详情
            ├── MyContributionsPage.tsx  # 我的贡献
            ├── LeaderboardPage.tsx     # 排行榜
            └── IncentiveRulesPage.tsx  # 激励规则
```

---

## 三、集成边界

| 能力 | 自建 | 集成 | 隔离位置 |
|------|------|------|----------|
| 项目立项、贡献聚合、激励计算 | ✅ | | collector/*.py |
| Cursor API 调用 | | ✅ Cursor 官方 | **cursor_api.py 唯一** |
| 管理端 + 成员端 | ✅ | | web/src |
| 数据库 | ✅ | PostgreSQL | db/migrations |

**约束**：
- 所有 Cursor API 调用必须经 `cursor_api.py`，不得在其他模块直接请求。
- API 层做可插拔适配器模式，便于未来接入其他数据源。

---

## 四、数据流

```
管理员立项 → POST /api/projects → projects 表（名称、仓库、预算、激励池）
    ↓
AI Code Tracking API → ai_code_sync.py → ai_code_commits 表
    （commit 级 AI 代码归因，通过 repo_name 匹配 project_id）
    ↓
Admin API → sync.py → members, daily_usage, spend_snapshots
    ↓
贡献度计算 → contribution_engine.py → contribution_scores
    （按项目+成员+周期聚合，结合激励规则计算得分与分配）
    ↓
管理端：项目维度（预算+贡献）/ 人员维度（排行+激励）
成员端：我的贡献（AI 代码、效率、激励份额）
```

---

## 五、数据库

- **PostgreSQL 16**，迁移为 SQL 文件幂等执行（启动时 `database.init_db()` 按序执行）。
- 时间字段统一 **TIMESTAMPTZ**。
- 核心表：`projects`、`members`、`daily_usage`、`spend_snapshots`、`ai_code_commits`、`contribution_scores`、`incentive_rules`、`leaderboard_snapshots`、`alert_rules`、`alert_events`。

---

## 六、已废弃（v3.0）

以下模块/文件在 v3.0 中废弃，不再维护：

- `cursor-admin/hook/` — Hook 客户端（Python + Java）
- `collector/hook_templates/` — Hook 模板
- `collector/git_sync.py` — Git CLI 扫描（被 ai_code_sync.py 替代）
- `collector/gitlab_client.py` — GitLab API 集成
- `agent_sessions` 表 — Hook 上报数据
- `git_contributions` 表 — Git CLI 扫描数据

---

## 七、文档引用

| 查什么 | 去哪里 |
|--------|--------|
| 架构决策 | `docs/ARCHITECTURE.md` |
| Spec 总览 | `.kiro/specs/SPEC_TASKS_SCAN.md` |
| 项目立项设计 | `.kiro/specs/cursor-admin-projects/` |
| AI 代码同步设计 | `.kiro/specs/cursor-admin-ai-tracking/` |
| 激励设计 | `.kiro/specs/cursor-admin-incentives/` |

---

**执行承诺**：项目为一等实体 · Cursor API 单点出口 · 纯服务端无 Hook · 文档驱动
