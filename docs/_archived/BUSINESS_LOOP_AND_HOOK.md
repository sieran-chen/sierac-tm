# 业务闭环与 Hook：说明与 Spec 缺口

> 回应：「检测不到 Hook 上报，不就是业务闭环不通吗？其它内容怎么会展示？」以及「目前的功能 spec 还没有完全？」

---

## 一、结论先说

1. **检测不到 Hook 上报 = 业务闭环在「项目参与 / 会话归属 / 激励」这一侧确实不通。** 与闭环直接相关的内容（项目参与、成本归属、贡献得分、排行榜）在没有 Hook 时本来就不会有数据；能展示的只有**不依赖 Hook** 的部分。
2. **功能 spec 在「业务逻辑」上已经写全**（立项、白名单、Hook 协议、三源融合、激励闭环）。**缺的是两件事的显式 spec**：**闭环是否已接通的可验证性**（平台如何知道「已有 Hook 上报」）、以及**无 Hook 时的产品形态**（先展示什么、如何引导）。

---

## 二、业务闭环里 Hook 的角色（与 spec 一致）

设计上闭环是：

```
贡献可见 → 排行激励 → 主动参与 → 贡献更多
```

数据流是：

| 数据来源 | 内容 | 是否依赖 Hook |
|----------|------|----------------|
| **Cursor API**（定时同步） | 成员、用量、支出 | 否 |
| **Hook 上报**（POST /api/sessions） | 会话、工作目录、时长、**project_id** | **是** |
| **Git 采集**（定时扫描项目仓库） | commit、diff、按人按项目 | 否（只依赖项目配置了关联仓库） |

- **项目参与**、**项目详情的成本/参与成员**：来自 `agent_sessions`，且需要 `project_id`。`project_id` 只能由 Hook 在 `beforeSubmitPrompt` 匹配白名单后，在 `stop` 上报时带上。**没有 Hook 上报 → 没有带 project_id 的会话 → 项目参与/成本归属为空。**
- **贡献度计算**：三源 = `git_contributions` + `agent_sessions` + `daily_usage`。其中**会话维度**（时长、项目归属）只来自 Hook；`hook_adopted` 也由「本周期是否有 Hook 数据」决定。**没有 Hook 上报 → 会话维度为 0，且默认「仅已接入 Hook」时排行榜无人或很少人。**
- **治理（白名单拦截）**：`beforeSubmitPrompt` 检查工作目录是否在白名单，不匹配则拦截。**这也是 Hook 的能力；没有 Hook，就没有这层治理。**

所以：**检测不到 Hook 上报，就等于「项目参与 / 会话归属 / 激励闭环 / 白名单治理」这条业务闭环不通。** 这是设计上的必然，不是实现 bug。

---

## 三、闭环不通时，「其它内容」为什么还能展示？

「其它内容」可以分成两类：

| 能展示的（不依赖 Hook） | 不能有数据的（依赖 Hook） |
|-------------------------|----------------------------|
| 用量总览（Cursor API） | 项目参与（按项目聚合的会话） |
| 支出管理（Cursor API） | 项目详情的「成本 / 参与成员」 |
| 项目管理（CRUD、关联仓库、工作目录规则） | 贡献得分里的「会话维度」 |
| 项目详情的「关联仓库、工作目录规则、Git 贡献」 | 排行榜（hook_only 时） |
| 我的项目（Git 贡献聚合，来自 git_contributions） | 白名单拦截/放行 |

也就是说：  
- **能展示的**：用量、支出、项目配置、Git 贡献（在配置了关联仓库且 Git 采集跑起来的前提下）。  
- **不能有数据的**：一切依赖 `agent_sessions` 和 `project_id` 的东西——项目参与、成本归属、贡献得分/排行、治理。

所以**不是「闭环不通其它内容也不该展示」**，而是：**闭环不通时，与闭环直接相关的那几块本来就没数据；产品上我们选择仍然展示这些入口，用空状态 + 文案说明「数据从哪来、要怎么做才能有数据」**（例如引导装 Hook、立项、配置仓库）。  
若产品策略改为「闭环未通时只突出用量 + 项目配置 + 安装引导，弱化或隐藏排行/我的贡献」，也可以，但那属于**无 Hook 时的产品形态**，见下节。

---

## 四、功能 spec 是否完全？

### 4.1 已写全的部分

- **业务逻辑**：立项、白名单、Hook 协议（beforeSubmitPrompt + stop）、会话上报与 project_id、三源融合、贡献度计算、排行榜、与 Hook 挂钩（仅认可 Hook 数据、参与门槛、个人收益）——在 core / hooks / projects / incentives 的 requirements 与 design 里都已覆盖。
- **数据流与依赖**：ARCHITECTURE 与各 spec 已说明「Hook 是参与信号」「agent_sessions 仅装 Hook 者有」「没有 Hook 则会话维度为 0 / 不参与排行」。
- **E2E 验证**：立项 → Hook 放行/拦截 → 上报归属 → Git 采集 → 管理端展示，以及激励侧的「Hook 上报 → 计算 → 排行榜展示」都有对应步骤。

所以：**从「功能要做什么、数据从哪来」的角度，spec 是完整的。**

### 4.2 尚未显式成 spec 的两块

1. **闭环可验证性（Hook 是否已接通）**  
   - 现状：没有「平台侧」的明确能力：**判断当前环境是否已经收到过至少一次 Hook 上报**，或在管理端/成员端有一处**「Hook 状态：已接通 / 未接通」**的展示。  
   - 结果：只能通过「项目参与里有没有带 project_id 的会话」「我的贡献里是否 hook_adopted」等间接推断，没有一目了然的「闭环是否通」的入口。  
   - **建议补的 spec**：  
     - 定义「Hook 已接通」的判定（例如：某成员在某时间范围内有至少一条 `agent_sessions` 且带 `project_id`，或至少一条会话 regardless project_id）。  
     - 管理端/成员端提供「Hook 状态」或「闭环健康」的展示或入口（例如仪表盘一条「最近 7 天 Hook 上报：有/无」或「已接入 Hook 的成员数」）。

2. **无 Hook 时的产品形态**  
   - 现状：各页都有空状态与说明文案，但**没有**在 spec 里明确：  
     - 在「尚未有人装 Hook」时，**首页或主导航应该优先展示什么**（例如：用量 + 项目配置 + 「安装 Hook 以解锁项目参与与排行」）。  
     - 是否要在闭环未通时**弱化或隐藏**「项目参与」「排行榜」「我的贡献」等入口，避免「点进去全是空」的体验。  
   - **建议补的 spec**：  
     - 定义「无 Hook 时的产品策略」：例如优先展示用量与项目配置，并有一处明显的「接通 Hook → 解锁项目参与与激励」的引导（文案 + 链接到安装说明或 Hook 状态页）。  
     - 可选：当平台检测到「从未有过 Hook 上报」时，首页或仪表盘显示一条固定提示，并引导到「如何安装 Hook / 如何验证上报成功」。

---

## 五、总结表

| 问题 | 结论 |
|------|------|
| 检测不到 Hook 上报，是不是业务闭环不通？ | **是。** 项目参与、会话归属、激励闭环、白名单治理都依赖 Hook；没有 Hook 上报，这条闭环就不通。 |
| 闭环不通，其它内容怎么会展示？ | **能展示的** = 不依赖 Hook 的部分（用量、支出、项目配置、Git 贡献）；**不能有数据的** = 依赖 Hook 的部分（项目参与、成本归属、得分/排行）。当前是保留入口 + 空状态与说明；若希望「闭环未通时只突出部分入口」，需在产品形态 spec 里明确。 |
| 功能 spec 是否完全？ | **业务逻辑与数据流已写全。** 缺的是：（1）**闭环可验证性**（如何判定、在哪里展示「Hook 已接通」）；（2）**无 Hook 时的产品形态**（先展示什么、如何引导）。建议将这两点补成显式 spec 或设计文档。 |

---

## 六、后续 Spec 与文档

- **数据可见性（含 Git/支出不展示）**：见 `docs/DATA_VISIBILITY_AND_TROUBLESHOOTING.md` 与 spec `.kiro/specs/cursor-admin-loop-and-data/`（requirements、design、tasks）。该 spec 覆盖：用量/支出/Git/Hook 四类数据的展示条件与排查、闭环健康 API、无 Hook 时产品形态。
- **闭环可验证性、无 Hook 时产品形态**：已纳入 cursor-admin-loop-and-data，待按 tasks.md 实现。

---

**维护者**：团队  
**最后更新**：2026-02-26
